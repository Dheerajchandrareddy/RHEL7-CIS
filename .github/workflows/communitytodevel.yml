# This is a basic workflow to help you get started with Actions

name: CommunityToDevel

# Controls when the action will run.
# Triggers the workflow on push or pull request
# events but only for the devel branch
on:
  pull_request:
    branches: [ devel ]

# A workflow run is made up of one or more jobs
# that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, 
      # so your job can access it
      - uses: actions/checkout@v2

      - name: find file locations
        run: pwd; ls -laR

### Build out the server
      - name: Terraform init
        run: terraform init

      - name: terraform validate
        run: terraform validate

      - name: terraform apply
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_OS_TYPE: ${{ secrets.TF_OS_TYPE }}
        run: terraform apply -var-file "rocky8.tfvars" --auto-approve

## Run the ansible playbook

      - name: Play Ansible Playbook
        uses: arillso/action.playbook@master
        with:
          playbook: site.yml
          inventory: hosts.yml
          galaxy_file: collections/requirements.yml

        env:
          ANSIBLE_HOST_KEY_CHECKING: 'false'
          ANSIBLE_DEPRECATION_WARNINGS: 'false'
